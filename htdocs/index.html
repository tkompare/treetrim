<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1" />
	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
		<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	
	<!-- Le styles -->
	<link href="css/bootstrap.css" rel="stylesheet">
	<style type="text/css">
		body {
			padding-top: 60px;
			padding-bottom: 30px;
		}
	</style>
	<link href="css/bootstrap-responsive.css" rel="stylesheet">
	<title>Chicago Tree Trimmimg</title>
</head>
<body>
	<div class="container-fluid">
		<div class="row-fluid">
			<div class="span12">
				<div class="row-fluid">
					<div class="span3">
						<h2>Chicago Tree Trimming</h2>
						<p><a href="http://twitter.com/tomkompare"><em>Tom Kompare</em></a><br />
						Data Source: <a href="https://data.cityofchicago.org/Service-Requests/311-Service-Requests-Tree-Trims/uxic-zsuj">data.cityofchicago.org</a><br />
						<strong><span id="numResults">&nbsp;</span></strong></p>
						<form class="well">
						<label for="requests-all" class="radio">
							<input type="radio" id="requests-all" name="requests" checked="checked"> All Requests
						</label>
						<label for="requests-completed" class="radio">
							<input type="radio" id="requests-completed" name="requests"> Completed Requests
						</label>
						<label for="requests-pending" class="radio">
							<input type="radio" id="requests-pending" name="requests"> Pending Requests
						</label>
						<label for="wards" class="checkbox">
							<input type="checkbox" id="wards" name="wards"> Wards
						</label>
						</form>
					</div>
					<div class="span9">
						<div id="theMap" style="width:100%; height:640px"></div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<!-- Le javascript ================================================== -->
	<!-- Placed at the end of the document so the pages load faster -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
	<script src="js/bootstrap.min.js"></script>
	<script src="https://maps-api-ssl.google.com/maps/api/js?v=3.7&sensor=false" type="text/javascript"></script>
	<script type="text/javascript" src="http://www.google.com/jsapi"></script>
	<script type="text/javascript">
		google.load('visualization', '1', {});
		$(document).ready(function() {
			//Set up variaous variables
			var recordName = "result";
			var recordNamePlural = "results";
			var CenterLatLng = new google.maps.LatLng('41.845','-87.669');
			var fusionTableId = '3028961';
			var geoColumn = 'Location'
			var fusionLayer = null;
			var queryString = null;
			var myOptions = {
				zoom: 11,
				mapTypeControl: false,
				streetViewControl: false,
				panControl: false,
				zoomControl: true,
				zoomControlOptions: {
					style: google.maps.ZoomControlStyle.SMALL,
					position: google.maps.ControlPosition.LEFT_TOP
				},
				mapTypeId: google.maps.MapTypeId.ROADMAP
			};
			var mapDOM = document.getElementById('theMap');
			// Make the base map
			var theMap = new google.maps.Map(mapDOM, myOptions);
			theMap.setCenter(CenterLatLng);
			// Add the Tree Trim Data Layer.
			function setQueryString() {
				queryString = "SELECT " + geoColumn + " FROM " + fusionTableId;
			}
			setQueryString();
			fusionLayer = new google.maps.FusionTablesLayer(fusionTableId,{
				query: queryString
			});
			fusionLayer.setMap(theMap);
			displayCount(queryString);
			// Tree Trim Data Listeners
			$("#requests-all").click(function() {
				setQueryString();
				fusionLayer.setMap(null);
				fusionLayer = new google.maps.FusionTablesLayer(fusionTableId,{
					query: queryString
				});
				fusionLayer.setMap(theMap);
				displayCount(queryString);
			});
			$("#requests-completed").click(function() {
				setQueryString();
				queryString = queryString + " WHERE Status LIKE '%Completed%'"
				fusionLayer.setMap(null);
				fusionLayer = new google.maps.FusionTablesLayer(fusionTableId,{
					query: queryString
				});
				fusionLayer.setMap(theMap);
				displayCount(queryString);
			});
			$("#requests-pending").click(function() {
				setQueryString();
				queryString = queryString + " WHERE Status LIKE '%Open%'"
				fusionLayer.setMap(null);
				fusionLayer = new google.maps.FusionTablesLayer(fusionTableId,{
					query: queryString
				});
				fusionLayer.setMap(theMap)
				displayCount(queryString);
			});
			// Ward Layer Listeners
			var wardLayer = new google.maps.FusionTablesLayer(3057562,{
				query: "SELECT geometry FROM 3057562"
			});
			$("#wards").click(function() {
				if($("#wards").is(':checked'))
				{
					fusionLayer.setMap(null);
					wardLayer.setMap(theMap);
					fusionLayer.setMap(theMap);
				}
				else
				{
					wardLayer.setMap(null);
				}
			});
			// Getting Tree Trim Count
			function getFTQuery(sql) {
				var queryText = encodeURIComponent(sql);
				return new google.visualization.Query('http://www.google.com/fusiontables/gvizdata?tq=' + queryText);
			}
			function displayCount(queryString)
			{
			$( "#numResults" ).fadeOut(function() {
				$( "#numResults" ).html("Calculating count...");
			});
			$( "#numResults" ).fadeIn();
			 queryString = queryString.replace("SELECT " + geoColumn,"SELECT Count() ")
				//set the callback function
				getFTQuery(queryString).send(displaySearchCount);
			}
			//Add in commas into numbers
			function addCommas(nStr)
			{
				nStr += '';
				x = nStr.split('.');
				x1 = x[0];
				x2 = x.length > 1 ? '.' + x[1] : '';
				var regx = /(\d+)(\d{3})/;
				while (regx.test(x1)) {
				x1 = x1.replace(regx, '$1' + ',' + '$2');
				}
				return x1 + x2;
			}
			function displaySearchCount(response)
			{
				var numRows = 0;
				if (response.getDataTable().getNumberOfRows() > 0)
				{
					numRows = parseInt(response.getDataTable().getValue(0, 0));
				}
				var name = recordNamePlural;
				if (numRows == 1)
				{
					name = recordName;
				}
				$( "#numResults" ).fadeOut(function() {
					$( "#numResults" ).html(addCommas(numRows) + " requests");
				});
				$( "#numResults" ).fadeIn();
			}
		});
	</script>
</body>
</html>